---
title: "E-TABM-585"
author: "Pablo Monfort-Lanzas"
date: "2024-05-31"
output: html_document
---

```{r, setup, include=FALSE}
library(ArrayExpress)
library(GEOquery)
library(affy)
library(hgu133plus2.db)
library(limma)
```

## Dataset Overview

The E-TABM-585 dataset comprises transcriptional profiling of human lung cancer cells (A549 cell line) treated with four kinase inhibitors: dasatinib, imatinib, nilotinib, or PD0325901. Treatments used a 12-point dose range (30 ÂµM with 3-fold dilutions down to 0.17 nM) with a 0.5% DMSO vehicle for all treatments. The data measures transcriptional responses at 4 hours for dasatinib, imatinib, nilotinib, and PD0325901, and at 20 hours for dasatinib, imatinib, and nilotinib. This dataset has been processed together and normalized using RMA, and the object was saved in RDA format.

## Load and Preprocess Data

In this section, we load the normalized and annotated data, combine metadata, and filter the data for the specific compound (dasatinib) and selected doses.

```{r, load-preprocess}
# Load the preprocessed data
load("../../Projects/TOX/ToxicoDataset/data/E-TABM-585/E-TABM-585_normalized_annotated.rda")

# Combine metadata
combine_metadata <- pData(gse_annotated)

compound <- "Nilotinib"
doses <- unique(combine_metadata$`Factor Value [dose]`)
time <- 4

# Filter data for the current compound and the selected doses
compound_samples <- combine_metadata$`Factor Value [compound]` %in% c("none", compound) &
  combine_metadata$`Factor Value [dose]` %in% doses &
  combine_metadata$`Factor Value [time]` %in% time

compound_data <- gse_annotated[, compound_samples]

# Ensure dose is numeric
dose <- as.numeric(combine_metadata$`Factor Value [dose]`[compound_samples])
dose_squared <- dose^2
```

## Differential Expression Analysis

Here, we perform differential expression analysis using the `limma` package, considering the dose and dose squared as covariates.

```{r, differential-expression}
# Design matrix for limma
design <- model.matrix(~ dose + dose_squared)

# Perform differential expression analysis using limma
fit <- lmFit(compound_data, design)
fit <- eBayes(fit)

# Extract results
res <- topTable(fit, coef="dose_squared", adjust="fdr", sort.by="p", number=nrow(fit))
res_symbol <- res[!duplicated(res$SYMBOL),]

# Filter significant genes
significant_genes <- res_symbol[(res_symbol$AveExpr > 10) & (res_symbol$adj.P.Val < 0.1), ]

# Extract metadata and expression data
metadata <- pData(compound_data)
expression_data <- exprs(compound_data)
expression_data <- expression_data[significant_genes$PROBEID,]
rownames(expression_data) <- significant_genes$SYMBOL
metadata$Dose <- metadata$`Factor Value [dose]`
```

## Perform DoseRider Analysis

In this section, we use the `DoseRider` package to analyze dose-response relationships at the pathway level using mixed models.

```{r, doserider-analysis}
library(SummarizedExperiment)
library(doseRider)

# Create SummarizedExperiment object
se <- doseRider::create_summarized_experiment(expression_data, metadata)
se$Dose <- se$`Factor Value [dose]`
se$sample <- colnames(se)

# Specify the path to your GMT file
gmt_perturbation_path <- "../external/c2.cgp.v2023.2.Hs.symbols.gmt"
mio_path <- "../external/MIO_geneset_symbols.gmt"
# Use the function to read the GMT file
gmt_p_data <- filter_gmt_by_size(read_gmt(gmt_perturbation_path),10,800)

# Perform DoseRider analysis
dose_rider_results <- DoseRiderParallel(se = se, gmt = gmt_p_data, 
                                           dose_col = "Dose", omic = "microarray", 
                                           minGSsize = 10, maxGSsize = 800, 
                                           method = "fdr", covariates = c(),
                                           modelType = "LMM", num_cores = 10,
                                           clusterResults = TRUE, FilterPathway = TRUE,
                                           pca_threshold = 0.6)
#print(dose_rider_results)

# Filter DoseRider results
dose_rider_results_filter <- filter_DoseRider(doseRiderObj = dose_rider_results, filter_type = "pvalue", threshold = 0.01, model_type = "non_linear")
print(dose_rider_results_filter)

```

## Plot Results


We visualize the results from the DoseRider analysis using various plots to understand the dose-response relationships better.

```{r plot-results, fig.width=10, fig.height=7}
library(ggplot2)
# Custom theme for dose_rider plots
top <- 10
save_path <- "/home/monfortl/plots/Example_results/Array/"

# Create directory to save plots
dir.create(save_path, showWarnings = FALSE)

# Generate and save plots
p1 <- dose_response_heatmap(dose_rider_results_filter, dose_col = "Dose", top = top, order_column = "best_model_pvalue", decreasing = FALSE )
plotFile1 <- paste0(save_path, "/plot1.jpeg")
jpeg(file=plotFile1, width = 600, height = 500, units = "px")
plot(p1, heatmap_legend_side = "bottom", annotation_legend_side = "bottom",padding = unit(c(2, 2, 2, 2), "cm"))
dev.off()

p2 <- plot_gene_set_random_effects(dose_rider_results_filter, dose_col = "Dose", order_column = "best_model_pvalue", top = top) 
plotFile2 <- paste0(save_path, "/plot2.jpeg")
ggsave(plotFile2, plot = p2, width = 250, height = 150, units = "mm", dpi = 600)

p3 <- plot_top_pathway_responses(dose_rider_results_filter, top = 6, ncol = 3, order_column = "best_model_pvalue")
plotFile3 <- paste0(save_path, "/plot3.jpeg")
ggsave(plotFile3, plot = p3, width = 400, height = 200, units = "mm", dpi = 600)

p4 <- plot_gene_random_effect_relationship(dose_rider_results_filter, "JOHNSTONE_PARVB_TARGETS_2_UP")
plotFile4 <- paste0(save_path, "/plot4.jpeg")
ggsave(plotFile4, plot = p4, width = 400, height = 200, units = "mm", dpi = 600)

p5 <- plot_dotplot_top_pathways(dose_rider_results_filter, top = top, order_column = "Genes", decreasing = TRUE)
plotFile5 <- paste0(save_path, "/plot5.jpeg")
ggsave(plotFile5, plot = p5, width = 400, height = 200, units = "mm", dpi = 600)

p6 <- create_gene_heatmap(dose_rider_results_filter, dose_col = "Dose", gene_set_name = "JOHNSTONE_PARVB_TARGETS_2_UP")
plotFile6 <- paste0(save_path, "/plot6.jpeg")
jpeg(file=plotFile6, width = 700, height = 700, units = "px")
plot(p6)
dev.off()

data_bmd <- get_bmd_range(dose_rider_results = dose_rider_results_filter)
p7 <- plot_bmd_density_and_peaks(data_bmd)
plotFile7 <- paste0(save_path, "/plot7.jpeg")
ggsave(plotFile7, plot = p7, width = 400, height = 200, units = "mm", dpi = 600)
```

